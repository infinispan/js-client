#!/usr/bin/env groovy

pipeline {
    agent {
        label 'slave-group-release'
    }

    parameters {
        string(name: 'version', defaultValue: '0.0.0', description: 'Release version')
        string(name: 'branch', defaultValue: 'master', description: 'Branch to release from')
    }

    options {
        timeout(time: 60, unit: 'MINUTES')
    }

    stages {
        stage('Install release package') {
            steps {
                nodejs(nodeJSInstallationName: 'Node 0.10') {
                    sh 'npm install npm-release'
                }
            }
        }

        stage('Release') {
            steps {
                nodejs(nodeJSInstallationName: 'Node 0.10') {
                    sh "npm-release ${version}"
                }
            }
        }

        stage('Generate JS API docs and upload') {
            steps {
                sh './node_modules/.bin/jsdoc lib/*.js'
                sh 'mv out apidocs'
                sh 'mkdir 1.0'
                sh 'mv apidocs 1.0'
                sh 'rsync -rv --protocol=28 1.0 infinispan@filemgmt.jboss.org:/docs_htdocs/infinispan/hotrod-clients/javascript'
                sh 'mv 1.0 out'
            }
        }

    }
}
